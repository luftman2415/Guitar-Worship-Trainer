<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Guitar Worship Trainer Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Favicon GW -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%234f46e5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='900' font-size='250' fill='white'%3EGW%3C/text%3E%3C/svg%3E" />

    <!-- Librer铆as Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Estilos Externos -->
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
        
        // Registro de Service Worker
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                });
            });
        }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <!-- L贸gica de la Aplicaci贸n -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("GW Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-6 text-center bg-slate-50 dark:bg-slate-900">
                            <div className="max-w-md bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl">
                                <div className="text-red-500 text-5xl mb-4">锔</div>
                                <h2 className="text-xl font-bold mb-2 dark:text-white">Algo sali贸 mal</h2>
                                <p className="text-slate-500 mb-6 text-sm">Error: {this.state.error?.message || 'Desconocido'}</p>
                                <button onClick={() => { 
                                    if(navigator.serviceWorker) {
                                        navigator.serviceWorker.getRegistrations().then(function(registrations) {
                                            for(let registration of registrations) { registration.unregister(); } 
                                            window.location.reload();
                                        });
                                    } else {
                                        window.location.reload();
                                    }
                                }} className="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-brand-700 transition-colors w-full">Borrar Cach茅 y Recargar</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ICONOS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>,
                mic: <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>,
                micOff: <path d="M1 1l22 22M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>,
                activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>,
                music: <path d="M9 18V5l12-2v13"></path>,
                grid: <rect x="3" y="3" width="7" height="7"></rect>,
                sun: <circle cx="12" cy="12" r="5"></circle>,
                moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>,
                play: <polygon points="5 3 19 12 5 21 5 3"></polygon>,
                pause: <rect x="6" y="4" width="4" height="16"></rect>,
                stop: <rect x="6" y="6" width="12" height="12"></rect>,
                plus: <line x1="12" y1="5" x2="12" y2="19"></line>,
                minus: <line x1="5" y1="12" x2="19" y2="12"></line>,
                search: <circle cx="11" cy="11" r="8"></circle>,
                trash: <polyline points="3 6 5 6 21 6"></polyline>,
                edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>,
                award: <circle cx="12" cy="8" r="7"></circle>,
                clock: <circle cx="12" cy="12" r="10"></circle>,
                x: <line x1="18" y1="6" x2="6" y2="18"></line>,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>,
                analyze: <path d="M2 12h10M9 4v16M3 7l13 13M16 7l-13 13"></path>,
                alert: <circle cx="12" cy="12" r="10"></circle>,
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>,
                ear: <path d="M12 2a10 10 0 0 0-10 10v7a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2H4a8 8 0 0 1 15.6 1.6"></path>,
                circle: <circle cx="12" cy="12" r="10"></circle>,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>,
                upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>,
                layers: <g><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></g>,
                repeat: <g><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></g>,
                lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></g>,
                file: <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>,
                check: <polyline points="20 6 9 17 4 12"></polyline>,
                rewind: <polygon points="11 19 2 12 11 5 11 19"></polygon>,
                arrowLeft: <g><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></g>
            };

            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || extras[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const DB_NAME = 'gwt_audio_db';
        const DB_STORE = 'recordings';

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(DB_STORE)) {
                        db.createObjectStore(DB_STORE, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const saveRecordingToDB = async (recording) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DB_STORE], 'readwrite');
                const store = transaction.objectStore(DB_STORE);
                const request = store.add(recording);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const getRecordingsFromDB = async () => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DB_STORE], 'readonly');
                const store = transaction.objectStore(DB_STORE);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const deleteRecordingFromDB = async (id) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DB_STORE], 'readwrite');
                const store = transaction.objectStore(DB_STORE);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const DialogContext = createContext();

        const DialogProvider = ({ children }) => {
            const [dialog, setDialog] = useState({ isOpen: false, title: '', message: '', type: 'confirm', onConfirm: null, promptMode: false, promptCallback: null });

            const close = () => setDialog({ ...dialog, isOpen: false, promptMode: false });

            const confirm = ({ title, message, onConfirm, type = 'confirm' }) => {
                setDialog({ isOpen: true, title, message, type, onConfirm: () => { onConfirm(); close(); } });
            };

            const alert = ({ title, message, onConfirm }) => {
                setDialog({ isOpen: true, title, message, type: 'alert', onConfirm: () => { if(onConfirm) onConfirm(); close(); } });
            };
            
            const prompt = ({ title, message, onConfirm }) => {
                setDialog({ 
                    isOpen: true, 
                    title, 
                    message, 
                    type: 'confirm', 
                    promptMode: true, 
                    onConfirm: (val) => { onConfirm(val); close(); } 
                });
            };

            return (
                <DialogContext.Provider value={{ confirm, alert, prompt }}>
                    {children}
                    {dialog.isOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300">
                            <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-modal border border-slate-100 dark:border-slate-700">
                                <div className="p-6 text-center">
                                    <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${dialog.type === 'alert' ? 'bg-brand-100 text-brand-600' : 'bg-red-100 text-red-600'}`}>
                                        <Icon name={dialog.type === 'alert' ? 'award' : 'alert'} size={24} />
                                    </div>
                                    <h3 className="text-xl font-bold mb-2 dark:text-white">{dialog.title}</h3>
                                    <p className="text-slate-500 dark:text-slate-400 text-sm mb-6 leading-relaxed">{dialog.message}</p>
                                    
                                    {dialog.promptMode && (
                                        <input 
                                            autoFocus 
                                            id="promptInput" 
                                            className="w-full p-3 bg-slate-50 dark:bg-slate-700 rounded-xl mb-6 dark:text-white border border-slate-200 dark:border-slate-600"
                                            placeholder="Escribe aqu铆..."
                                        />
                                    )}

                                    <div className="flex gap-3 justify-center">
                                        {dialog.type === 'confirm' && (
                                            <button onClick={close} className="px-5 py-2.5 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition-colors">
                                                Cancelar
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => {
                                                if(dialog.promptMode) {
                                                    const val = document.getElementById('promptInput').value;
                                                    dialog.onConfirm(val);
                                                } else {
                                                    dialog.onConfirm();
                                                }
                                            }} 
                                            className={`px-6 py-2.5 rounded-xl text-white font-bold shadow-lg transition-transform active:scale-95 ${dialog.type === 'alert' ? 'bg-brand-600 hover:bg-brand-700' : 'bg-red-500 hover:bg-red-600'}`}
                                        >
                                            {dialog.type === 'alert' ? 'Entendido' : 'Confirmar'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </DialogContext.Provider>
            );
        };

        const useDialog = () => useContext(DialogContext);

        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const SCALES = {
            'Mayor (J贸nica)': [0, 2, 4, 5, 7, 9, 11],
            'D贸rica': [0, 2, 3, 5, 7, 9, 10],
            'Frigia': [0, 1, 3, 5, 7, 8, 10],
            'Lidia': [0, 2, 4, 6, 7, 9, 11],
            'Mixolidia': [0, 2, 4, 5, 7, 9, 10],
            'Menor (E贸lica)': [0, 2, 3, 5, 7, 8, 10],
            'Locria': [0, 1, 3, 5, 6, 8, 10],
            'Pentat贸nica Menor': [0, 3, 5, 7, 10],
            'Pentat贸nica Mayor': [0, 2, 4, 7, 9],
            'Blues': [0, 3, 5, 6, 7, 10],
        };
        const CHORD_FORMULAS = [
            { name: "Mayor", formula: "1 - 3 - 5", example: "C - E - G" },
            { name: "Menor", formula: "1 - b3 - 5", example: "C - Eb - G" },
            { name: "Disminuido", formula: "1 - b3 - b5", example: "C - Eb - Gb" },
            { name: "Aumentado", formula: "1 - 3 - #5", example: "C - E - G#" },
            { name: "Sus2", formula: "1 - 2 - 5", example: "C - D - G" },
            { name: "Sus4", formula: "1 - 4 - 5", example: "C - F - G" },
            { name: "Maj7", formula: "1 - 3 - 5 - 7", example: "C - E - G - B" },
            { name: "min7", formula: "1 - b3 - 5 - b7", example: "C - Eb - G - Bb" },
            { name: "Dom7", formula: "1 - 3 - 5 - b7", example: "C - E - G - Bb" },
        ];

        const useAudioContext = () => {
            const audioContextRef = useRef(null);
            const getContext = useCallback(() => {
                if (!audioContextRef.current) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (AudioContextClass) audioContextRef.current = new AudioContextClass();
                }
                return audioContextRef.current;
            }, []);
            const resume = useCallback(async () => {
                const ctx = getContext();
                if (ctx && ctx.state === 'suspended') await ctx.resume();
                return ctx;
            }, [getContext]);
            return { getContext, resume };
        };

        // --- GLOBAL PAD ENGINE HOOK ---
        const usePadEngine = () => {
            const [activeKey, setActiveKey] = useState(null);
            const [volume, setVolume] = useState(0.3);
            const [isPlaying, setIsPlaying] = useState(false);
            const audioCtxRef = useRef(null);
            const gainNodeRef = useRef(null);
            const oscillatorsRef = useRef([]);
            const KEYS = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

            // Init Audio Context on Mount (Lazy)
            const getCtx = () => {
                if (!audioCtxRef.current) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    const ctx = new AudioContextClass();
                    const masterGain = ctx.createGain();
                    masterGain.connect(ctx.destination);
                    masterGain.gain.value = 0;
                    audioCtxRef.current = ctx;
                    gainNodeRef.current = masterGain;
                }
                return audioCtxRef.current;
            };

            // Update Volume
            useEffect(() => {
                if (gainNodeRef.current && audioCtxRef.current) {
                    gainNodeRef.current.gain.setTargetAtTime(isPlaying ? volume : 0, audioCtxRef.current.currentTime, 0.1);
                }
            }, [volume, isPlaying]);

            // Handle Pad Playback
            useEffect(() => {
                // If not playing, don't start new sounds, but do NOT stop context if we want smooth fade
                if (!activeKey || !isPlaying) return;
                
                const ctx = getCtx();
                
                // Fade out old oscillators
                oscillatorsRef.current.forEach(({ osc, gain }) => {
                    try {
                        gain.gain.setTargetAtTime(0, ctx.currentTime, 0.5); 
                        setTimeout(() => { try{ osc.stop(); }catch(e){} }, 600);
                    } catch(e){}
                });
                oscillatorsRef.current = [];

                const rootIndex = KEYS.indexOf(activeKey);
                const freqs = [
                    130.81 * Math.pow(2, rootIndex / 12), // Root
                    130.81 * Math.pow(2, (rootIndex + 7) / 12), // 5th
                    261.63 * Math.pow(2, rootIndex / 12) // Octave
                ];

                freqs.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const oscGain = ctx.createGain();
                    const filter = ctx.createBiquadFilter();

                    osc.type = i === 2 ? 'sine' : 'sawtooth';
                    osc.frequency.value = freq;
                    filter.type = 'lowpass';
                    filter.frequency.value = 600;
                    filter.Q.value = 1;

                    osc.connect(filter);
                    filter.connect(oscGain);
                    oscGain.connect(gainNodeRef.current);

                    oscGain.gain.setValueAtTime(0, ctx.currentTime);
                    oscGain.gain.linearRampToValueAtTime(0.2 / (i + 1), ctx.currentTime + 1); // Fade in

                    osc.start();
                    oscillatorsRef.current.push({ osc, gain: oscGain });
                });

            }, [activeKey, isPlaying]);

            const togglePlay = async () => {
                const ctx = getCtx();
                if (ctx.state === 'suspended') await ctx.resume();
                
                const newState = !isPlaying;
                setIsPlaying(newState);
                
                if (!newState) {
                    // Stop sound if turning off
                    oscillatorsRef.current.forEach(({ osc, gain }) => {
                        gain.gain.setTargetAtTime(0, ctx.currentTime, 0.1);
                        setTimeout(() => { try{ osc.stop(); }catch(e){} }, 200);
                    });
                    oscillatorsRef.current = [];
                }
            };

            const selectKey = (k) => {
                setActiveKey(k);
                if (!isPlaying) togglePlay(); 
            };

            return { activeKey, setActiveKey: selectKey, volume, setVolume, isPlaying, togglePlay, KEYS };
        };

        // --- COMPONENTES ---

        const ProgressStats = () => {
            const [stats, setStats] = useState({ streak: 0, totalMinutes: 0, lastDate: null });
            const dialog = useDialog();
            
            useEffect(() => {
                loadStats();
                const handleUpdate = () => loadStats();
                window.addEventListener('gwt-stats-updated', handleUpdate);
                return () => window.removeEventListener('gwt-stats-updated', handleUpdate);
            }, []);

            const loadStats = () => {
                const savedRaw = localStorage.getItem('gwt_stats');
                const saved = savedRaw ? JSON.parse(savedRaw) : { streak: 0, totalMinutes: 0, lastDate: null };
                setStats(saved);
            };

            const resetStats = () => {
                dialog.confirm({
                    title: "驴Reiniciar estad铆sticas?",
                    message: "Esto borrar谩 tu racha actual y los minutos acumulados. Esta acci贸n no se puede deshacer.",
                    type: 'alert',
                    onConfirm: () => {
                        localStorage.setItem('gwt_stats', JSON.stringify({ streak: 0, totalMinutes: 0, lastDate: null }));
                        window.dispatchEvent(new Event('gwt-stats-updated'));
                    }
                });
            };

            return (
                <div className="relative group">
                    <div className="grid grid-cols-2 gap-4 w-full">
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center relative overflow-hidden">
                            <div className="p-2 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-full mb-2 z-10"><Icon name="award" size={20} /></div>
                            <span className="text-2xl font-bold text-slate-800 dark:text-white z-10">{stats.streak}</span>
                            <span className="text-xs text-slate-500 font-medium z-10">D铆as racha</span>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center">
                            <div className="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full mb-2"><Icon name="clock" size={20} /></div>
                            <span className="text-2xl font-bold text-slate-800 dark:text-white">{stats.totalMinutes.toFixed(1)}</span>
                            <span className="text-xs text-slate-500 font-medium">Minutos totales</span>
                        </div>
                    </div>
                    <button onClick={resetStats} className="absolute -top-3 -right-3 p-2 bg-slate-200 dark:bg-slate-700 text-slate-500 rounded-full md:opacity-0 md:group-hover:opacity-100 transition-opacity hover:bg-red-100 hover:text-red-500 shadow-sm" title="Reiniciar estad铆sticas"><Icon name="trash" size={14} /></button>
                </div>
            );
        };

        const logPracticeTime = (minutes) => {
            const raw = localStorage.getItem('gwt_stats');
            const saved = raw ? JSON.parse(raw) : { streak: 0, totalMinutes: 0, lastDate: null };
            
            const today = new Date().toDateString();
            let newStreak = saved.streak;
            
            if (saved.lastDate !== today) {
                if (!saved.lastDate) {
                    newStreak = 1;
                } else {
                    const last = new Date(saved.lastDate);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (last.toDateString() === yesterday.toDateString()) {
                        newStreak += 1;
                    } else {
                        newStreak = 1;
                    }
                }
            }
            
            const newStats = { 
                streak: newStreak, 
                totalMinutes: (Number(saved.totalMinutes) || 0) + minutes, 
                lastDate: today 
            };
            
            localStorage.setItem('gwt_stats', JSON.stringify(newStats));
            window.dispatchEvent(new Event('gwt-stats-updated'));
        };

        const Tuner = () => {
            const { resume, getContext } = useAudioContext();
            const [isActive, setIsActive] = useState(false); const [note, setNote] = useState('--'); const [cents, setCents] = useState(0); const [errorMsg, setErrorMsg] = useState(null); const analyserRef = useRef(null); const rafRef = useRef(null); const streamRef = useRef(null);
            const autoCorrelate = (buf, sampleRate) => { let size = buf.length, rms = 0; for (let i = 0; i < size; i++) rms += buf[i] * buf[i]; if (Math.sqrt(rms / size) < 0.015) return -1; let r1 = 0, r2 = size - 1, thres = 0.2; for (let i = 0; i < size / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; } for (let i = 1; i < size / 2; i++) if (Math.abs(buf[size - i]) < thres) { r2 = size - i; break; } const buf2 = buf.slice(r1, r2); size = buf2.length; const c = new Float32Array(size); for (let i = 0; i < size; i++) for (let j = 0; j < size - i; j++) c[i] = c[i] + buf2[j] * buf2[j + i]; let d = 0; while (c[d] > c[d + 1]) d++; let maxval = -1, maxpos = -1; for (let i = d; i < size; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; } let T0 = maxpos; const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1]; const a = (x1 + x3 - 2 * x2) / 2, b = (x3 - x1) / 2; if (a) T0 = T0 - b / (2 * a); return sampleRate / T0; };
            const updatePitch = () => { const ctx = getContext(); if (!analyserRef.current || !ctx) return; const buf = new Float32Array(2048); analyserRef.current.getFloatTimeDomainData(buf); const ac = autoCorrelate(buf, ctx.sampleRate); if (ac !== -1) { const noteNum = 12 * (Math.log(ac / 440) / Math.log(2)); const noteRaw = Math.round(noteNum) + 69; setNote(NOTES[noteRaw % 12]); setCents(Math.floor(1200 * Math.log2(ac / (440 * Math.pow(2, (noteRaw - 69) / 12))))); } rafRef.current = requestAnimationFrame(updatePitch); };
            const toggleTuner = async () => { if (isActive) { if (rafRef.current) cancelAnimationFrame(rafRef.current); if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop()); setIsActive(false); setNote('--'); setCents(0); } else { setErrorMsg(null); await resume(); const ctx = getContext(); try { const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } }); streamRef.current = stream; const source = ctx.createMediaStreamSource(stream); const analyser = ctx.createAnalyser(); analyser.fftSize = 2048; source.connect(analyser); analyserRef.current = analyser; setIsActive(true); updatePitch(); } catch (err) { setErrorMsg("Error: Permiso de micr贸fono denegado."); } } };
            useEffect(() => () => { if(isActive) toggleTuner(); }, []);
            const isInTune = isActive && note !== '--' && Math.abs(cents) < 5; const colorClass = !isActive ? 'text-slate-300' : isInTune ? 'text-emerald-500' : 'text-amber-500';
            return (<div className="flex flex-col items-center p-8 bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 max-w-sm mx-auto"><h2 className="text-2xl font-bold mb-6 text-slate-800 dark:text-white">Afinador</h2>{errorMsg && <div className="mb-4 p-2 bg-red-100 text-red-600 text-xs rounded">{errorMsg}</div>}<div className="relative w-64 h-64 mb-8"><div className="absolute inset-0 rounded-full border-8 border-slate-100 dark:border-slate-700"></div><div className="absolute inset-0 flex flex-col items-center justify-center"><span className={`text-8xl font-black ${colorClass} transition-colors`}>{note}</span><span className="text-slate-400 font-mono mt-2">{isActive ? (note !== '--' ? `${cents > 0 ? '+' : ''}${cents}` : 'Escuchando...') : 'OFF'}</span></div>{isActive && note !== '--' && (<div className={`absolute top-0 left-1/2 w-2 h-8 -ml-1 rounded-full origin-bottom transition-all duration-100 ${isInTune ? 'bg-emerald-500' : 'bg-amber-500'}`} style={{ top: '-10px', height: '30px', transformOrigin: '50% 138px', transform: `rotate(${cents * 1.5}deg)` }} />)}</div><div className="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full mb-8 overflow-hidden relative"><div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-slate-400 z-10"></div>{isActive && note !== '--' && <div className={`h-full transition-all duration-75 ${isInTune ? 'bg-emerald-500' : 'bg-amber-500'}`} style={{ width: '10%', position: 'absolute', left: `calc(50% + ${cents}%)`, transform: 'translateX(-50%)', borderRadius: '99px' }}></div>}</div><button onClick={toggleTuner} className={`flex items-center gap-3 px-8 py-4 rounded-2xl font-bold text-white transition-all w-full justify-center shadow-lg ${isActive ? 'bg-rose-500 hover:bg-rose-600' : 'bg-brand-600 hover:bg-brand-700'}`}><Icon name={isActive ? "micOff" : "mic"} /> {isActive ? "Detener" : "Activar Micr贸fono"}</button></div>);
        };

        const TrackTrainer = () => {
            const [file, setFile] = useState(null);
            const [audioUrl, setAudioUrl] = useState(null);
            const [speed, setSpeed] = useState(1.0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [loopStart, setLoopStart] = useState(null);
            const [loopEnd, setLoopEnd] = useState(null);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [showSetlist, setShowSetlist] = useState(false);
            const [isLocalMode, setIsLocalMode] = useState(false);
            const audioRef = useRef(null);
            const fileInputRef = useRef(null);

            // CORRECCION URLS ARCHIVOS
            const TEACHER_TRACKS = [
                { title: "La Sunamita", filename: "La Sunamita.mp3" },
                { title: "100% No hay lugar m谩s alto", filename: "No hay lugar mas alto.mp3" },
                { title: "Santo es el que vive", filename: "Santo es el que vive.mp3" },
                { title: "100% Si tu presencia conmigo no va", filename: "100% Si tu presencia conmigo no va.mp3" },
                { title: "Tus cuerdas de amor", filename: "Tus cuerdas de amor.mp3" }
            ];
            
            useEffect(() => {
                if (window.location.protocol === 'file:') { setIsLocalMode(true); }
            }, []);

            const handleFileChange = (e) => {
                const selected = e.target.files[0];
                if (selected) {
                    setFile(selected);
                    setAudioUrl(URL.createObjectURL(selected));
                    setSpeed(1.0); setLoopStart(null); setLoopEnd(null); setIsPlaying(false); setShowSetlist(false);
                }
            };

            const loadTeacherTrack = (track) => {
                const path = `./tracks/${encodeURIComponent(track.filename)}`; 
                setAudioUrl(path);
                setFile({ name: track.title });
                setSpeed(1.0); setLoopStart(null); setLoopEnd(null); 
                setIsPlaying(true); // Auto-play when selecting a track
                setShowSetlist(false);
            };

            useEffect(() => {
                const audio = audioRef.current;
                if (!audio) return;
                audio.playbackRate = speed;
                if (audio.preservesPitch !== undefined) { audio.preservesPitch = true; } 
                else if (audio.mozPreservesPitch !== undefined) { audio.mozPreservesPitch = true; } 
                
                const handleTimeUpdate = () => {
                    setCurrentTime(audio.currentTime);
                    if (loopEnd !== null && loopStart !== null && audio.currentTime >= loopEnd) {
                        audio.currentTime = loopStart;
                        if(isPlaying) audio.play();
                    }
                };
                const handleLoadedMetadata = () => { if (audio.duration && audio.duration !== Infinity) setDuration(audio.duration); };
                const handleEnded = () => setIsPlaying(false);
                
                audio.addEventListener('timeupdate', handleTimeUpdate);
                audio.addEventListener('loadedmetadata', handleLoadedMetadata);
                audio.addEventListener('ended', handleEnded);
                return () => {
                    audio.removeEventListener('timeupdate', handleTimeUpdate);
                    audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
                    audio.removeEventListener('ended', handleEnded);
                };
            }, [speed, loopStart, loopEnd, isPlaying, audioUrl]);

            // Force reload
            useEffect(() => { if(audioRef.current && audioUrl) audioRef.current.load(); }, [audioUrl]);

            const togglePlay = () => { const audio = audioRef.current; if (isPlaying) audio.pause(); else audio.play().catch(e=>console.log(e)); setIsPlaying(!isPlaying); };
            const stop = () => { const audio = audioRef.current; audio.pause(); audio.currentTime = loopStart || 0; setIsPlaying(false); };
            const handleSeek = (e) => { const t = parseFloat(e.target.value); audioRef.current.currentTime = t; setCurrentTime(t); };
            const setPointA = () => setLoopStart(currentTime);
            const setPointB = () => { if (loopStart !== null && currentTime > loopStart) { setLoopEnd(currentTime); audioRef.current.currentTime = loopStart; if(!isPlaying) togglePlay(); } };
            const clearLoop = () => { setLoopStart(null); setLoopEnd(null); };
            const formatTime = (t) => { if (!t) return "0:00"; const m = Math.floor(t/60); const s = Math.floor(t%60); return `${m}:${s<10?'0':''}${s}`; };

            return (
                <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 max-w-2xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <div className="p-3 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-full"><Icon name="music" size={24} /></div>
                            <div><h2 className="text-xl font-bold dark:text-white">Entrenador de Pistas</h2><p className="text-xs text-slate-500">Carga MP3 o usa la lista.</p></div>
                        </div>
                        <button onClick={() => setShowSetlist(!showSetlist)} className="text-xs font-bold text-indigo-600 bg-indigo-50 dark:text-indigo-300 dark:bg-indigo-900/20 px-3 py-2 rounded-lg hover:bg-indigo-100 transition-colors">{showSetlist ? 'Cerrar Lista' : ' Repertorio'}</button>
                    </div>
                    {showSetlist && (
                        <div className="mb-6 p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-700 animate-fade-in">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Canciones Disponibles</h3>
                            <div className="space-y-2">
                                {TEACHER_TRACKS.map((track, idx) => (
                                    <button key={idx} onClick={() => loadTeacherTrack(track)} className="w-full text-left p-3 bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center gap-3 group transition-all">
                                        <span className="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 text-xs flex items-center justify-center font-bold">{idx + 1}</span>
                                        <span className="font-bold text-sm text-slate-700 dark:text-slate-200 truncate">{track.title}</span>
                                        <span className="ml-auto opacity-0 group-hover:opacity-100 text-indigo-500"><Icon name="play" size={16}/></span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    {!audioUrl ? (
                        <div onClick={() => fileInputRef.current.click()} className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-12 text-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                            <input ref={fileInputRef} type="file" accept="audio/*" className="hidden" onChange={handleFileChange} />
                            <div className="text-slate-400 group-hover:text-brand-500 mb-4 mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 transition-colors"><Icon name="file" size={32} /></div>
                            <p className="text-slate-600 dark:text-slate-300 font-bold">Toca para cargar MP3</p>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            <div className="bg-slate-100 dark:bg-slate-900 px-4 py-3 rounded-xl flex justify-between items-center"><span className="text-sm font-bold truncate max-w-[200px] dark:text-white">{file?.name}</span><button onClick={() => { setAudioUrl(null); setFile(null); }} className="text-xs text-red-500 hover:text-red-600 font-bold">Cambiar</button></div>
                            <audio ref={audioRef} src={audioUrl} preload="auto" onCanPlay={() => { if(isPlaying && audioRef.current) audioRef.current.play().catch(e=>console.log(e)); }} />
                            <div className="flex justify-center gap-6 items-center">
                                <button onClick={stop} className="p-4 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white hover:bg-slate-300"><Icon name="stop" fill="currentColor" /></button>
                                <button onClick={togglePlay} className={`w-20 h-20 rounded-full flex items-center justify-center text-white shadow-xl transition-transform active:scale-95 ${isPlaying ? 'bg-amber-500' : 'bg-brand-600'}`}><Icon name={isPlaying ? "pause" : "play"} size={40} fill="currentColor" /></button>
                            </div>
                            <div className="space-y-1"><input type="range" min="0" max={duration || 100} value={currentTime} onChange={handleSeek} className="w-full h-3 bg-slate-200 rounded-full appearance-none cursor-pointer dark:bg-slate-700 accent-brand-600"/><div className="flex justify-between text-xs font-mono text-slate-500"><span>{formatTime(currentTime)}</span><span>{formatTime(duration)}</span></div></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700"><label className="text-xs font-bold text-slate-500 uppercase flex justify-between mb-3"><span>Velocidad</span><span className="bg-brand-100 text-brand-700 px-2 rounded">{Math.round(speed * 100)}%</span></label><input type="range" min="0.5" max="1.2" step="0.05" value={speed} onChange={(e) => setSpeed(parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer dark:bg-slate-600 accent-brand-600"/><div className="flex justify-between mt-2"><button onClick={() => setSpeed(0.5)} className="text-[10px] bg-white px-2 py-1 rounded shadow-sm">50%</button><button onClick={() => setSpeed(1.0)} className="text-[10px] bg-white px-2 py-1 rounded shadow-sm font-bold text-brand-600">100%</button></div></div>
                                <div className="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700 flex flex-col justify-between"><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-500 uppercase">Loop A-B</span>{(loopStart!==null||loopEnd!==null)&&<button onClick={clearLoop} className="text-xs text-red-500 font-bold">Borrar</button>}</div><div className="flex gap-2"><button onClick={setPointA} className={`flex-1 py-3 rounded-lg font-bold text-sm transition-colors ${loopStart!==null?'bg-indigo-100 text-indigo-700 border-2 border-indigo-500':'bg-white dark:bg-slate-800 dark:text-white shadow-sm'}`}>{loopStart!==null?'A: '+formatTime(loopStart):'Set A'}</button><button onClick={setPointB} disabled={loopStart===null} className={`flex-1 py-3 rounded-lg font-bold text-sm transition-colors ${loopEnd!==null?'bg-indigo-100 text-indigo-700 border-2 border-indigo-500':'bg-white dark:bg-slate-800 dark:text-white shadow-sm disabled:opacity-50'}`}>{loopEnd!==null?'B: '+formatTime(loopEnd):'Set B'}</button></div></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const IdeaRecorder = () => {
            const { getContext, resume } = useAudioContext();
            const [isRecording, setIsRecording] = useState(false);
            const [recordings, setRecordings] = useState([]);
            const [timer, setTimer] = useState(0);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);
            const dialog = useDialog(); // Added Dialog Hook

            useEffect(() => { loadRecordings(); }, []);

            useEffect(() => {
                if (isRecording) {
                    timerRef.current = setInterval(() => setTimer(prev => prev + 1), 1000);
                } else {
                    clearInterval(timerRef.current);
                    setTimer(0);
                }
                return () => clearInterval(timerRef.current);
            }, [isRecording]);

            const loadRecordings = async () => {
                try {
                    const recs = await getRecordingsFromDB();
                    setRecordings(recs.sort((a,b) => b.date - a.date));
                } catch(e) { console.error(e); }
            };

            const startRecording = async () => {
                await resume(); // FIX: Resume audio context immediately
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = e => chunksRef.current.push(e.data);
                    mediaRecorderRef.current.onstop = async () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const id = Date.now();
                        await saveRecordingToDB({ id, blob, date: new Date() });
                        loadRecordings();
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                } catch (e) { alert("Error al acceder al micr贸fono"); }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                }
            };

            const playRecording = (blob) => {
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.play();
            };

            const deleteRec = (id) => {
                dialog.confirm({
                    title: "驴Borrar grabaci贸n?",
                    message: "Esta acci贸n no se puede deshacer.",
                    onConfirm: async () => {
                        await deleteRecordingFromDB(id);
                        loadRecordings();
                    }
                });
            };

            return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in">
                    <div className="absolute top-4 right-4 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-xs font-mono font-bold text-slate-500">
                        {isRecording ? new Date(timer * 1000).toISOString().substr(14, 5) : '0:00'}
                    </div>
                    <h2 className="text-2xl font-bold mb-8 text-slate-800 dark:text-white">Grabadora de Ideas</h2>
                    <div className="flex justify-center mb-6">
                        <button onClick={isRecording ? stopRecording : startRecording} className={`w-32 h-32 rounded-full flex flex-col items-center justify-center shadow-2xl transition-all border-4 ${isRecording ? 'bg-red-600 border-red-300 animate-pulse scale-105' : 'bg-red-500 border-red-100 hover:scale-105'}`}>
                            <span className="text-5xl font-bold text-white mb-1">{isRecording ? timer : '0'}</span>
                        </button>
                    </div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-10">{isRecording ? 'GRABANDO...' : 'TOQUE PARA GRABAR'}</p>
                    <div className="text-left">
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">MIS IDEAS ({recordings.length})</h3>
                        <div className="space-y-3">
                            {recordings.length === 0 && (<div className="p-6 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl text-center text-slate-400 text-xs">No tienes grabaciones guardadas a煤n.</div>)}
                            {recordings.map(rec => (
                                <div key={rec.id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded-xl group transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">
                                    <div className="flex items-center gap-3"><button onClick={() => playRecording(rec.blob)} className="w-10 h-10 flex items-center justify-center bg-white dark:bg-slate-800 rounded-full text-slate-700 dark:text-white shadow-sm hover:scale-110 transition-transform"><Icon name="play" size={14} fill="currentColor"/></button><div><p className="text-xs font-bold dark:text-white">Idea {new Date(rec.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}).toLowerCase()}</p><p className="text-[10px] text-slate-400">{new Date(rec.date).toLocaleDateString()}</p></div></div>
                                    <button onClick={() => deleteRec(rec.id)} className="text-slate-300 hover:text-red-500 transition-colors p-2"><Icon name="minus" size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const JamLooper = () => {
            const { getContext, resume } = useAudioContext();
            const [status, setStatus] = useState('idle'); 
            const [audioBuffer, setAudioBuffer] = useState(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const sourceNodeRef = useRef(null);
            const dialog = useDialog(); // Added Dialog Hook

            const startRecording = async () => {
                await resume(); // FIX: Resume audio context immediately
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                mediaRecorderRef.current = new MediaRecorder(stream);
                chunksRef.current = [];
                mediaRecorderRef.current.ondataavailable = e => chunksRef.current.push(e.data);
                mediaRecorderRef.current.onstop = async () => {
                    const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                    const arrayBuffer = await blob.arrayBuffer();
                    const ctx = getContext();
                    try {
                        const decodedBuffer = await ctx.decodeAudioData(arrayBuffer);
                        setAudioBuffer(decodedBuffer);
                    } catch (e) {
                        console.error("Error decoding audio", e);
                        alert("Error procesando audio. Intenta de nuevo.");
                    }
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorderRef.current.start();
                setStatus('recording');
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && status === 'recording') {
                    mediaRecorderRef.current.stop();
                    setStatus('idle');
                }
            };

            const playLoop = async () => {
                await resume(); // FIX: Resume audio context immediately
                const ctx = getContext();
                if (!audioBuffer) return;
                const source = ctx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;
                source.connect(ctx.destination);
                source.start();
                sourceNodeRef.current = source;
                setStatus('looping');
            };

            const stopLoop = () => {
                if (sourceNodeRef.current) sourceNodeRef.current.stop();
                setStatus('idle');
            };

            const clearLoop = () => {
                if(!audioBuffer) return;
                dialog.confirm({
                    title: "驴Borrar Loop?",
                    message: "Perder谩s lo que acabas de grabar.",
                    onConfirm: () => {
                        if (status === 'looping') stopLoop();
                        setAudioBuffer(null);
                        setStatus('idle');
                    }
                });
            };

            const handleMainAction = () => {
                if (status === 'idle' && !audioBuffer) startRecording();
                else if (status === 'recording') stopRecording();
                else if (status === 'idle' && audioBuffer) playLoop();
                else if (status === 'looping') stopLoop();
            };

            return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in relative overflow-hidden">
                    <div className="w-20 h-20 bg-teal-100 dark:bg-teal-900/30 text-teal-600 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="repeat" size={40} /></div>
                    <h2 className="text-3xl font-black mb-2 text-slate-800 dark:text-white">Jam Looper</h2>
                    <p className="text-slate-500 text-sm mb-10">Cero latencia. Graba y toca encima al instante.</p>
                    <div className="flex justify-center mb-10 relative">
                        <div className={`w-40 h-40 rounded-full flex items-center justify-center border-[6px] transition-all duration-300 relative ${status === 'recording' ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : status === 'looping' ? 'border-teal-500 bg-teal-50 dark:bg-teal-900/20' : 'border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800'}`}>
                            {status === 'looping' && (<div className="absolute inset-0 rounded-full border-[6px] border-t-teal-200 border-r-transparent border-b-transparent border-l-transparent animate-spin"></div>)}
                            <button onClick={handleMainAction} className="flex flex-col items-center justify-center w-full h-full z-10">
                                {status === 'recording' ? (<><div className="w-4 h-4 bg-red-500 rounded-sm mb-2 animate-pulse"></div><span className="text-xs font-bold text-red-500 uppercase tracking-widest">Grabando</span></>) : status === 'looping' ? (<><span className="text-4xl font-black text-teal-600">ON</span><span className="text-[10px] font-bold text-teal-400 uppercase tracking-widest mt-1">Looping</span></>) : !audioBuffer ? (<><span className="text-5xl font-medium text-slate-400 mb-2">0</span><span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Grabar</span></>) : (<><Icon name="play" size={32} className="text-teal-500 mb-1 ml-1" fill="currentColor"/><span className="text-xs font-bold text-teal-500 uppercase tracking-widest">Play</span></>)}
                            </button>
                        </div>
                    </div>
                    <div className="flex gap-4 items-center justify-center">
                        {audioBuffer ? (<><button onClick={() => { stopLoop(); playLoop(); }} className="bg-teal-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-teal-600/30 hover:bg-teal-700 active:scale-95 transition-all"><Icon name="repeat" size={18} /> Re-Sync</button><button onClick={clearLoop} className="bg-red-50 text-red-500 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-red-100 transition-colors"><Icon name="minus" size={18} /> Borrar</button></>) : (<p className="text-xs text-slate-400">Pulsa el c铆rculo para comenzar</p>)}
                    </div>
                </div>
            );
        };

        const Metronome = () => {
            const { resume, getContext } = useAudioContext();
            const [isPlaying, setIsPlaying] = useState(false);
            const [bpm, setBpm] = useState(120);
            const [beatsPerMeasure, setBeatsPerMeasure] = useState(4);
            const [subdivision, setSubdivision] = useState(1);
            const [visualBeat, setVisualBeat] = useState(false);
            const [trainerEnabled, setTrainerEnabled] = useState(false);
            const [trainerBars, setTrainerBars] = useState(4);
            const [trainerBpmInc, setTrainerBpmInc] = useState(5);
            const [presets, setPresets] = useState([]);
            
            const nextNoteTimeRef = useRef(0); const timerIDRef = useRef(null); const currentNoteRef = useRef(0); const currentBarRef = useRef(0); const startTimeRef = useRef(0); const tapTimesRef = useRef([]);
            const bpmRef = useRef(bpm); const bpmIncRef = useRef(trainerBpmInc); const barsIncRef = useRef(trainerBars); const trainerEnabledRef = useRef(trainerEnabled);
            const dialog = useDialog();
            const isPlayingRef = useRef(isPlaying);
            useEffect(() => { isPlayingRef.current = isPlaying; }, [isPlaying]);

            useEffect(() => { bpmRef.current = bpm; }, [bpm]); useEffect(() => { bpmIncRef.current = trainerBpmInc; }, [trainerBpmInc]); useEffect(() => { barsIncRef.current = trainerBars; }, [trainerBars]); useEffect(() => { trainerEnabledRef.current = trainerEnabled; }, [trainerEnabled]);
            useEffect(() => { const savedPresets = localStorage.getItem('gwt_metronome_presets'); if (savedPresets) setPresets(JSON.parse(savedPresets)); }, []);

            const playClick = (time, type) => { 
                const ctx = getContext(); if (!ctx) return; 
                const osc = ctx.createOscillator(); 
                const gain = ctx.createGain(); 
                osc.connect(gain); 
                gain.connect(ctx.destination); 
                if (type === 0) { osc.frequency.setValueAtTime(1500, time); gain.gain.setValueAtTime(1, time); } 
                else if (type === 1) { osc.frequency.setValueAtTime(1000, time); gain.gain.setValueAtTime(0.7, time); } 
                else { osc.frequency.setValueAtTime(800, time); gain.gain.setValueAtTime(0.3, time); } 
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); 
                osc.start(time); 
                osc.stop(time + 0.05); 
            };

            const scheduler = useCallback(() => { const ctx = getContext(); if (!ctx) return; while (nextNoteTimeRef.current < ctx.currentTime + 0.1) { const beatIndex = currentNoteRef.current; const notesPerMeasure = beatsPerMeasure * subdivision; let type = 2; if (beatIndex % notesPerMeasure === 0) type = 0; else if (beatIndex % subdivision === 0) type = 1; if (type === 0 && beatIndex > 0) { currentBarRef.current++; if (trainerEnabledRef.current && currentBarRef.current % barsIncRef.current === 0) { const newBpm = Math.min(300, bpmRef.current + bpmIncRef.current); bpmRef.current = newBpm; setBpm(newBpm); } } playClick(nextNoteTimeRef.current, type); if (type !== 2) { setTimeout(() => { setVisualBeat(true); setTimeout(() => setVisualBeat(false), 80); }, (nextNoteTimeRef.current - ctx.currentTime) * 1000); } nextNoteTimeRef.current += (60.0 / bpmRef.current) / subdivision; currentNoteRef.current++; } timerIDRef.current = setTimeout(scheduler, 25); }, [getContext, beatsPerMeasure, subdivision]);
            
            const togglePlay = () => { 
                if (isPlaying) { 
                    setIsPlaying(false); clearTimeout(timerIDRef.current); 
                    if (startTimeRef.current > 0) { const elapsed = (Date.now() - startTimeRef.current) / 60000; if (elapsed > 0.0) logPracticeTime(elapsed); startTimeRef.current = 0; } 
                } else { 
                    startTimeRef.current = Date.now(); 
                    resume().then((ctx) => { // FIX: Resume audio context immediately
                        if(ctx) { 
                            currentNoteRef.current = 0; currentBarRef.current = 0; nextNoteTimeRef.current = ctx.currentTime + 0.05; 
                            setIsPlaying(true); scheduler(); 
                        }
                    }); 
                } 
            };
            const handleTap = () => { const now = Date.now(); let times = tapTimesRef.current; if (times.length > 0 && now - times[times.length - 1] > 2000) times = []; times.push(now); if (times.length > 4) times.shift(); tapTimesRef.current = times; if (times.length > 1) { let intervals = []; for (let i = 1; i < times.length; i++) intervals.push(times[i] - times[i-1]); const avg = intervals.reduce((a, b) => a + b) / intervals.length; const newBpm = Math.round(60000 / avg); if (newBpm >= 30 && newBpm <= 300) setBpm(newBpm); } };
            
            useEffect(() => { return () => { clearTimeout(timerIDRef.current); if (isPlayingRef.current && startTimeRef.current > 0) { const elapsed = (Date.now() - startTimeRef.current) / 60000; if (elapsed > 0.0) logPracticeTime(elapsed); } }; }, []);

            const savePreset = () => { dialog.prompt({ title: "Guardar configuraci贸n", message: "Asigna un nombre a este preset:", onConfirm: (name) => { if(!name) return; const newPreset = { id: Date.now(), name, bpm, beatsPerMeasure, subdivision, trainerEnabled, trainerBars, trainerBpmInc }; const updated = [...presets, newPreset]; setPresets(updated); localStorage.setItem('gwt_metronome_presets', JSON.stringify(updated)); } }); };
            const loadPreset = (p) => { setBpm(p.bpm); setBeatsPerMeasure(p.beatsPerMeasure); setSubdivision(p.subdivision); setTrainerEnabled(p.trainerEnabled); setTrainerBars(p.trainerBars); setTrainerBpmInc(p.trainerBpmInc); };
            const deletePreset = (id, e) => { e.stopPropagation(); const updated = presets.filter(p => p.id !== id); setPresets(updated); localStorage.setItem('gwt_metronome_presets', JSON.stringify(updated)); };

            return (<div className="flex flex-col items-center bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 max-w-md mx-auto overflow-hidden animate-fade-in">
                <h2 className="text-3xl font-black text-center mt-8 mb-2 dark:text-white">Metr贸nomo</h2>
                <div className="w-full bg-slate-50 dark:bg-slate-900 p-8 flex flex-col items-center relative"><div className={`w-32 h-32 rounded-full flex items-center justify-center transition-all duration-75 relative ${visualBeat ? 'bg-brand-100 dark:bg-brand-900/30 scale-105' : 'bg-slate-200 dark:bg-slate-800'}`}>{visualBeat && <div className="absolute inset-0 rounded-full animate-pulse-ring"></div>}<div className="text-5xl font-black text-slate-800 dark:text-white font-mono z-10">{bpm}</div><div className="absolute bottom-6 text-xs text-slate-400 font-bold tracking-widest uppercase">BPM</div></div></div><div className="w-full p-6 space-y-6"><div className="flex items-center gap-4"><button onClick={() => setBpm(b => Math.max(30, b - 1))} className="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200"><Icon name="minus" /></button><input type="range" min="30" max="250" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="flex-1 h-3 bg-slate-200 rounded-full appearance-none cursor-pointer dark:bg-slate-700 accent-brand-600" /><button onClick={() => setBpm(b => Math.min(300, b + 1))} className="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200"><Icon name="plus" /></button></div><div className="flex gap-4"><button onClick={togglePlay} className={`flex-1 py-4 rounded-2xl text-white font-bold text-lg shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 ${isPlaying ? 'bg-rose-500 hover:bg-rose-600' : 'bg-brand-600 hover:bg-brand-700'}`}><Icon name={isPlaying ? "pause" : "play"} fill="currentColor" /> {isPlaying ? "STOP" : "START"}</button><button onClick={handleTap} className="px-6 py-4 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-300 dark:hover:bg-slate-600 active:scale-95 transition-colors">TAP</button></div><div className="grid grid-cols-2 gap-4"><div className="space-y-2"><label className="text-xs font-bold text-slate-500 uppercase">Comp谩s</label><select value={beatsPerMeasure} onChange={(e) => setBeatsPerMeasure(Number(e.target.value))} className="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold dark:text-white outline-none focus:ring-2 focus:ring-brand-500"><option value="2">2/4</option><option value="3">3/4</option><option value="4">4/4</option><option value="5">5/4</option><option value="6">6/8</option></select></div><div className="space-y-2"><label className="text-xs font-bold text-slate-500 uppercase">Subdivisi贸n</label><select value={subdivision} onChange={(e) => setSubdivision(Number(e.target.value))} className="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold dark:text-white outline-none focus:ring-2 focus:ring-brand-500"><option value="1">Negras</option><option value="2">Corcheas</option><option value="3">Tresillos</option><option value="4">Semicorcheas</option></select></div></div><div className={`p-4 rounded-xl border-2 transition-colors ${trainerEnabled ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20' : 'border-slate-100 dark:border-slate-700'}`}><div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2"><Icon name="zap" className={trainerEnabled ? "text-brand-500" : "text-slate-400"} size={18} /><span className="font-bold text-sm dark:text-white">Entrenador de Velocidad</span></div><button onClick={() => setTrainerEnabled(!trainerEnabled)} className={`w-12 h-6 rounded-full transition-colors relative ${trainerEnabled ? 'bg-brand-500' : 'bg-slate-300 dark:bg-slate-600'}`}><div className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${trainerEnabled ? 'left-7' : 'left-1'}`}></div></button></div>{trainerEnabled && (<div className="flex flex-col gap-3 mt-3"><div className="flex items-center justify-between"><span className="text-sm dark:text-slate-300">Subir BPM</span><div className="flex items-center gap-3 bg-white dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-600"><button onClick={() => setTrainerBpmInc(v => Math.max(1, v - 1))} className="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:text-white">-</button><span className="font-bold w-6 text-center dark:text-white">{trainerBpmInc}</span><button onClick={() => setTrainerBpmInc(v => Math.min(20, v + 1))} className="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:text-white">+</button></div></div><div className="flex items-center justify-between"><span className="text-sm dark:text-slate-300">Cada (Compases)</span><div className="flex items-center gap-3 bg-white dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-600"><button onClick={() => setTrainerBars(v => Math.max(1, v - 1))} className="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:text-white">-</button><span className="font-bold w-6 text-center dark:text-white">{trainerBars}</span><button onClick={() => setTrainerBars(v => Math.min(32, v + 1))} className="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:text-white">+</button></div></div></div>)}</div><div className="pt-2 border-t border-slate-100 dark:border-slate-700"><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-400 uppercase">Mis Presets</span><button onClick={savePreset} className="text-xs text-brand-600 font-bold bg-brand-50 dark:bg-brand-900/30 px-2 py-1 rounded hover:bg-brand-100">Guardar Actual</button></div><div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{presets.length === 0 && <span className="text-xs text-slate-400 italic">No hay presets guardados.</span>}{presets.map(p => (<div key={p.id} onClick={() => loadPreset(p)} className="flex-shrink-0 bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600 group relative"><span className="text-sm font-bold dark:text-white mr-4">{p.name}</span><span className="text-xs text-slate-500 block">{p.bpm} BPM</span><button onClick={(e) => deletePreset(p.id, e)} className="absolute top-1 right-1 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="x" size={14}/></button></div>))}</div></div></div></div>);
        };

        const ChordAnalyzer = () => {
            const [input, setInput] = useState('');
            const [analysis, setAnalysis] = useState(null);
            const normalizeChord = (chordStr) => {
                if(!chordStr) return null;
                let c = chordStr.trim();
                c = c.charAt(0).toUpperCase() + c.slice(1);
                const match = c.match(/^([A-G][#b]?)(.*)$/);
                if (!match) return null;
                let root = match[1]; let quality = match[2]; 
                const flatMap = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
                if (flatMap[root]) root = flatMap[root];
                return { root, quality, original: c };
            };
            const analyzeChords = () => {
                if (!input.trim()) return;
                const rawChords = input.split(/[\s,-]+/).filter(c => c);
                const chords = rawChords.map(normalizeChord).filter(c => c);
                if (chords.length === 0) { setAnalysis({ error: "No se reconocieron acordes. Intenta usar notaci贸n americana (C, D, Em...)" }); return; }
                let bestKey = null; let maxScore = -999;
                const majorScaleIntervals = [0, 2, 4, 5, 7, 9, 11];
                NOTES.forEach((keyRoot, keyIndex) => {
                    let score = 0; const scaleNotesIndices = majorScaleIntervals.map(i => (keyIndex + i) % 12); const degrees = [];
                    chords.forEach(chord => {
                        const rootIndex = NOTES.indexOf(chord.root);
                        if (rootIndex === -1) { score -= 10; degrees.push({ chord: chord.original, degree: '?', func: 'Error' }); return; }
                        if (scaleNotesIndices.includes(rootIndex)) {
                            score += 1; const degreeIndex = scaleNotesIndices.indexOf(rootIndex);
                            const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii掳'];
                            degrees.push({ chord: chord.original, degree: romanNumerals[degreeIndex], func: 'Diat贸nico' });
                        } else { score -= 1; degrees.push({ chord: chord.original, degree: '?', func: 'Crom谩tico' }); }
                    });
                    if (score > maxScore) { maxScore = score; bestKey = { root: keyRoot, type: 'Mayor', degrees }; }
                });
                if(bestKey) setAnalysis(bestKey);
            };
            
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center">
                        <p className="text-slate-500 dark:text-slate-400 mb-6 max-w-md mx-auto text-sm">Descubre la tonalidad de tu canci贸n ingresando los acordes.</p>
                        <div className="flex flex-col sm:flex-row gap-2 mb-6">
                            <input value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && analyzeChords()} placeholder="Ej: G D Em C" className="flex-1 p-4 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 outline-none focus:ring-2 focus:ring-violet-500 dark:text-white font-mono text-lg"/>
                            <button onClick={analyzeChords} className="bg-violet-600 hover:bg-violet-700 text-white px-6 py-3 sm:py-0 rounded-xl font-bold transition-colors w-full sm:w-auto">Analizar</button>
                        </div>
                        {analysis && !analysis.error && (
                            <div className="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-6 text-left animate-fade-in">
                                <div className="flex justify-between items-start border-b border-slate-200 dark:border-slate-700 pb-4 mb-4">
                                    <div>
                                        <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Tonalidad Detectada</p>
                                        <h3 className="text-3xl font-black text-slate-800 dark:text-white">{analysis.root} <span className="text-violet-500">{analysis.type}</span></h3>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    {analysis.degrees.map((d, i) => (
                                        <div key={i} className="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                                            <div className="text-xl font-bold dark:text-white mb-1">{d.chord}</div>
                                            <div className="inline-block px-2 py-0.5 bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300 rounded text-xs font-bold mb-1">{d.degree}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {analysis?.error && (<div className="p-4 bg-red-100 text-red-600 rounded-xl font-bold text-sm">{analysis.error}</div>)}
                    </div>
                </div>
            );
        };

        const EarTrainer = () => {
            const { resume, getContext } = useAudioContext();
            const [gameState, setGameState] = useState('menu'); 
            const [level, setLevel] = useState(1);
            const [questionCount, setQuestionCount] = useState(0); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentInterval, setCurrentInterval] = useState(null);
            const [lastError, setLastError] = useState(null); 
            
            const ALL_INTERVALS = [
                { id: 'P1', name: "Un铆sono", semitones: 0 },
                { id: 'm2', name: "2da Menor", semitones: 1 },
                { id: 'M2', name: "2da Mayor", semitones: 2 },
                { id: 'm3', name: "3ra Menor", semitones: 3 },
                { id: 'M3', name: "3ra Mayor", semitones: 4 },
                { id: 'P4', name: "4ta Justa", semitones: 5 },
                { id: 'TT', name: "Tritono", semitones: 6 },
                { id: 'P5', name: "5ta Justa", semitones: 7 },
                { id: 'm6', name: "6ta Menor", semitones: 8 },
                { id: 'M6', name: "6ta Mayor", semitones: 9 },
                { id: 'm7', name: "7ma Menor", semitones: 10 },
                { id: 'M7', name: "7ma Mayor", semitones: 11 },
                { id: 'P8', name: "8va Justa", semitones: 12 }
            ];

            const LEVELS = {
                1: { 
                    name: "Nivel 1: Mayores y Justos", 
                    desc: "Intervalos b谩sicos y consonantes. Direcci贸n ascendente.",
                    types: ['P1', 'M2', 'M3', 'P4', 'P5', 'M6', 'M7', 'P8'],
                    direction: 'asc'
                },
                2: { 
                    name: "Nivel 2: Menores y Tritono", 
                    desc: "Intervalos m谩s oscuros y disonantes. Direcci贸n ascendente.",
                    types: ['m2', 'm3', 'TT', 'm6', 'm7'],
                    direction: 'asc'
                },
                3: { 
                    name: "Nivel 3: Maestro (Mix)", 
                    desc: "Todos los intervalos. Direcci贸n aleatoria (Ascendente/Descendente).",
                    types: ['All'],
                    direction: 'random'
                }
            };

            const QUESTIONS_PER_LEVEL = 10;

            const startLevel = async (lvl) => {
                await resume();
                setLevel(lvl);
                setQuestionCount(0);
                setLastError(null);
                generateQuestion(lvl);
                setGameState('quiz');
            };

            const generateQuestion = (currentLvl) => {
                const config = LEVELS[currentLvl];
                let possibleIds = config.types;
                if (possibleIds[0] === 'All') possibleIds = ALL_INTERVALS.map(i => i.id);

                const pool = ALL_INTERVALS.filter(i => possibleIds.includes(i.id));
                const target = pool[Math.floor(Math.random() * pool.length)];
                const rootFreq = 261.63 * Math.pow(2, Math.floor(Math.random() * 12) / 12); 
                let dir = config.direction;
                if (dir === 'random') {
                    dir = Math.random() < 0.5 ? 'asc' : 'desc';
                }
                
                setCurrentInterval({
                    ...target,
                    rootFreq,
                    direction: dir
                });

                setTimeout(() => playInterval(rootFreq, target.semitones, dir), 400);
            };

            const playInterval = async (rootFreq, semitones, direction) => {
                if (isPlaying) return;
                setIsPlaying(true);
                const ctx = getContext();
                if (!ctx) return;
                
                const playTone = (freq, startTime, duration) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.frequency.value = freq;
                    osc.type = 'triangle'; 
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.4, startTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                    osc.start(startTime);
                    osc.stop(startTime + duration);
                };

                const targetFreq = rootFreq * Math.pow(2, semitones / 12);
                const now = ctx.currentTime;
                
                if (direction === 'asc') {
                    playTone(rootFreq, now, 0.6);
                    playTone(targetFreq, now + 0.8, 0.8);
                } else {
                    playTone(targetFreq, now, 0.6);
                    playTone(rootFreq, now + 0.8, 0.8);
                }
                
                setTimeout(() => setIsPlaying(false), 1600);
            };

            const handleAnswer = (selectedId) => {
                if (!currentInterval) return;

                if (selectedId === currentInterval.id) {
                    const nextCount = questionCount + 1;
                    setQuestionCount(nextCount);
                    if (nextCount >= QUESTIONS_PER_LEVEL) {
                        setGameState('level_complete');
                    } else {
                        generateQuestion(level);
                    }
                } else {
                    setLastError(currentInterval);
                    setGameState('level_failed');
                }
            };

            if (gameState === 'menu') return (
                <div className="max-w-lg mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in">
                    <div className="p-4 bg-fuchsia-100 dark:bg-fuchsia-900/30 rounded-full mb-6 text-fuchsia-600 inline-block"><Icon name="ear" size={48} /></div>
                    <h2 className="text-3xl font-bold mb-2 dark:text-white">Entrenador Auditivo</h2>
                    <p className="text-slate-500 dark:text-slate-400 mb-8">Perfecciona tu o铆do. Debes acertar 10/10 para avanzar.</p>
                    <div className="space-y-4">
                        {[1, 2, 3].map(lvl => (
                            <button key={lvl} onClick={() => startLevel(lvl)} className="w-full bg-slate-50 dark:bg-slate-700 hover:bg-fuchsia-50 dark:hover:bg-fuchsia-900/20 border border-slate-200 dark:border-slate-600 hover:border-fuchsia-500 p-4 rounded-2xl transition-all group text-left relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name="play" size={60} className="text-fuchsia-500" /></div>
                                <h3 className="font-bold text-lg dark:text-white group-hover:text-fuchsia-600 transition-colors">{LEVELS[lvl].name}</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1 pr-8">{LEVELS[lvl].desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (gameState === 'level_failed') return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-modal">
                    <div className="w-20 h-20 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="x" size={40} /></div>
                    <h2 className="text-2xl font-bold mb-2 dark:text-white">隆Nivel Fallado!</h2>
                    <p className="text-slate-500 mb-6">El intervalo correcto era: <span className="font-bold text-slate-800 dark:text-white">{lastError?.name}</span>.</p>
                    <button onClick={() => setGameState('menu')} className="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white font-bold rounded-xl hover:opacity-90">Volver al Men煤</button>
                </div>
            );

            if (gameState === 'level_complete') return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-modal">
                    <div className="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="award" size={40} /></div>
                    <h2 className="text-2xl font-bold mb-2 dark:text-white">隆Nivel Completado!</h2>
                    <p className="text-emerald-600 font-bold mb-6 text-xl">10 / 10 Perfecto</p>
                    <div className="space-y-3">
                        {level < 3 && <button onClick={() => startLevel(level + 1)} className="w-full py-4 bg-fuchsia-600 text-white font-bold rounded-xl hover:bg-fuchsia-700 shadow-lg animate-pulse-ring">Siguiente Nivel</button>}
                        <button onClick={() => setGameState('menu')} className="w-full py-3 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-xl">Men煤 Principal</button>
                    </div>
                </div>
            );

            if (!currentInterval) return null;

            let currentOptions = [];
            const config = LEVELS[level];
            if (config.types[0] === 'All') currentOptions = ALL_INTERVALS;
            else currentOptions = ALL_INTERVALS.filter(i => config.types.includes(i.id));

            return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={() => setGameState('menu')} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={20}/></button>
                        <div className="flex flex-col items-center"><span className="text-xs font-bold text-fuchsia-500 uppercase tracking-widest">{LEVELS[level].name.split(':')[0]}</span><div className="text-sm font-bold dark:text-white">Progreso: {questionCount} / {QUESTIONS_PER_LEVEL}</div></div>
                        <div className="w-5"></div>
                    </div>
                    <div className="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full mb-8 overflow-hidden"><div className="bg-fuchsia-500 h-full transition-all duration-300" style={{ width: `${(questionCount / QUESTIONS_PER_LEVEL) * 100}%` }}></div></div>
                    <button onClick={() => playInterval(currentInterval.rootFreq, currentInterval.semitones, currentInterval.direction)} className={`w-28 h-28 rounded-full flex items-center justify-center mx-auto shadow-2xl transition-all mb-8 ${isPlaying ? 'bg-fuchsia-400 scale-95 ring-4 ring-fuchsia-200' : 'bg-fuchsia-600 hover:bg-fuchsia-700 hover:scale-105 text-white'}`}><Icon name="ear" size={48} fill="currentColor" /></button>
                    <p className="text-slate-400 text-xs mb-6">Toca para escuchar de nuevo</p>
                    <div className="grid grid-cols-2 gap-3">{currentOptions.map((opt) => (<button key={opt.id} onClick={() => handleAnswer(opt.id)} className="p-4 rounded-xl font-bold text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:border-fuchsia-500 hover:bg-fuchsia-50 dark:hover:bg-fuchsia-900/20 dark:text-white transition-all active:scale-95">{opt.name}</button>))}</div>
                </div>
            );
        };

        const ScaleStudio = () => {
            const [root, setRoot] = useState('C');
            const [scaleName, setScaleName] = useState('Mayor (J贸nica)');
            const [activeTab, setActiveTab] = useState('fretboard'); 
            const STRINGS = ['E', 'B', 'G', 'D', 'A', 'E'];
            const { getContext, resume } = useAudioContext();

            const OPEN_STRING_FREQS = [329.63, 246.94, 196.00, 146.83, 110.00, 82.41];

            const getScaleNotes = () => {
                const rootIndex = NOTES.indexOf(root);
                const intervals = SCALES[scaleName];
                return intervals.map(i => NOTES[(rootIndex + i) % 12]);
            };

            const playNote = async (stringIdx, fret) => {
                await resume();
                const ctx = getContext();
                if (!ctx) return;

                const baseFreq = OPEN_STRING_FREQS[stringIdx];
                const freq = baseFreq * Math.pow(2, fret / 12);

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = freq;

                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 1000;

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);

                const now = ctx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);

                osc.start(now);
                osc.stop(now + 1.5);
            };

            const getHarmonization = () => {
                const notes = getScaleNotes();
                const harmonized = [];
                for (let i = 0; i < notes.length; i++) {
                    if (scaleName.includes('Pentat贸nica') || scaleName.includes('Blues')) break; 

                    const rootNote = notes[i];
                    const thirdNote = notes[(i + 2) % 7];
                    const fifthNote = notes[(i + 4) % 7];
                    
                    const rootIdx = NOTES.indexOf(rootNote);
                    const thirdIdx = NOTES.indexOf(thirdNote);
                    const fifthIdx = NOTES.indexOf(fifthNote);
                    
                    let thirdInterval = (thirdIdx - rootIdx + 12) % 12;
                    let fifthInterval = (fifthIdx - rootIdx + 12) % 12;

                    let quality = "";
                    if (thirdInterval === 4 && fifthInterval === 7) quality = ""; 
                    else if (thirdInterval === 3 && fifthInterval === 7) quality = "m"; 
                    else if (thirdInterval === 3 && fifthInterval === 6) quality = "dim"; 
                    else if (thirdInterval === 4 && fifthInterval === 8) quality = "aug"; 
                    else quality = "?";

                    harmonized.push({ degree: i + 1, chord: rootNote + quality, notes: [rootNote, thirdNote, fifthNote] });
                }
                return harmonized;
            };

            const activeNotes = getScaleNotes();
            const harmony = getHarmonization();

            return (
                <div className="max-w-5xl mx-auto space-y-6">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700">
                        <h2 className="text-2xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2"><Icon name="grid" className="text-brand-500"/> Estudio de Escalas</h2>
                        <div className="flex flex-col md:flex-row gap-4 mb-6">
                            <div className="flex-1">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Tonalidad</label>
                                <select value={root} onChange={e => setRoot(e.target.value)} className="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl font-bold dark:text-white shadow-sm outline-none focus:ring-2 focus:ring-brand-500">
                                    {NOTES.map(n => <option key={n} value={n}>{n}</option>)}
                                </select>
                            </div>
                            <div className="flex-[2]">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Escala / Modo</label>
                                <select value={scaleName} onChange={e => setScaleName(e.target.value)} className="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl font-bold dark:text-white shadow-sm outline-none focus:ring-2 focus:ring-brand-500">
                                    {Object.keys(SCALES).map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-2 border-b border-slate-200 dark:border-slate-700 pb-1">
                            <button onClick={() => setActiveTab('fretboard')} className={`px-4 py-2 font-bold text-sm rounded-t-lg transition-colors ${activeTab === 'fretboard' ? 'bg-slate-100 dark:bg-slate-700 text-brand-600 dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>M谩stil</button>
                            <button onClick={() => setActiveTab('harmony')} className={`px-4 py-2 font-bold text-sm rounded-t-lg transition-colors ${activeTab === 'harmony' ? 'bg-slate-100 dark:bg-slate-700 text-brand-600 dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>Armonizaci贸n</button>
                            <button onClick={() => setActiveTab('formulas')} className={`px-4 py-2 font-bold text-sm rounded-t-lg transition-colors ${activeTab === 'formulas' ? 'bg-slate-100 dark:bg-slate-700 text-brand-600 dark:text-white' : 'text-slate-400 hover:text-slate-600'}`}>F贸rmulas</button>
                        </div>
                        <div className="pt-6 min-h-[300px]">
                            {activeTab === 'fretboard' && (
                                <div className="animate-fade-in">
                                    <div className="overflow-x-auto pb-4">
                                        <div className="min-w-[700px] bg-[#3e3428] p-1 rounded-lg border-4 border-[#2b241c] relative shadow-inner select-none">
                                            <div className="absolute inset-0 flex pointer-events-none">{[...Array(13)].map((_, i) => (<div key={i} className={`flex-1 border-r ${i===0?'border-slate-400 border-r-4':'border-slate-500/50'} relative`}>{[3,5,7,9].includes(i) && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-slate-400/30"></div>}{i===12 && <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-slate-400/30"></div>}{i===12 && <div className="absolute bottom-1/4 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-slate-400/30"></div>}</div>))}</div>
                                            <div className="flex flex-col py-2 relative z-10">{STRINGS.map((openNote, sIdx) => (<div key={sIdx} className="flex h-10 items-center relative"><div className="absolute w-full h-[2px] bg-[#a89f91] shadow-sm"></div>{[...Array(13)].map((_, fret) => {const note = NOTES[(NOTES.indexOf(openNote) + fret) % 12];const isRoot = note === root;return (<div key={fret} className="flex-1 flex justify-center relative z-20">{activeNotes.includes(note) && (<div onClick={() => playNote(sIdx, fret)} className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-md transition-all hover:scale-125 cursor-pointer active:scale-95 ${isRoot ? 'bg-rose-500 text-white ring-2 ring-white z-30 scale-110' : 'bg-brand-500 text-white hover:bg-brand-400'}`} title={`Tocar ${note}`}>{note}</div>)}</div>);})}</div>))}</div>
                                        </div>
                                    </div>
                                    <div className="mt-4 flex gap-4 text-xs text-slate-500 justify-center items-center flex-wrap"><div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-rose-500"></span> T贸nica</div><div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-brand-500"></span> Notas de la escala</div><div className="ml-4 text-brand-600 font-bold bg-brand-50 dark:bg-brand-900/20 px-2 py-1 rounded">隆Haz clic en las notas para o铆rlas! </div></div>
                                </div>
                            )}
                            {activeTab === 'harmony' && (
                                <div className="animate-fade-in">
                                    {(scaleName.includes('Pentat贸nica') || scaleName.includes('Blues')) ? (
                                        <div className="text-center p-8 text-slate-400 italic bg-slate-50 dark:bg-slate-900 rounded-2xl">Las escalas pentat贸nicas y blues no suelen armonizarse diat贸nicamente en triadas est谩ndar de la misma forma que las escalas mayores/menores.</div>
                                    ) : (
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4">{harmony.map((h, i) => (<div key={i} className="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl text-center border border-slate-100 dark:border-slate-700 hover:border-brand-500 transition-colors cursor-pointer group"><div className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-widest">Grado {h.degree}</div><div className="text-2xl font-black text-slate-800 dark:text-white mb-2 group-hover:text-brand-500">{h.chord}</div><div className="flex justify-center gap-1">{h.notes.map((n, idx) => (<span key={idx} className="text-[10px] bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 text-slate-500">{n}</span>))}</div></div>))}</div>
                                    )}
                                    <p className="mt-6 text-center text-sm text-slate-500 max-w-2xl mx-auto">Estas son las triadas que se forman naturalmente usando solo las notas de la escala <b>{root} {scaleName}</b>.</p>
                                </div>
                            )}
                            {activeTab === 'formulas' && (
                                <div className="animate-fade-in">
                                    <div className="overflow-x-auto rounded-2xl border border-slate-200 dark:border-slate-700"><table className="w-full text-sm text-left text-slate-500 dark:text-slate-400"><thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-200"><tr><th className="px-3 sm:px-6 py-3">Tipo de Acorde</th><th className="px-3 sm:px-6 py-3">F贸rmula (Intervalos)</th><th className="px-3 sm:px-6 py-3">Ejemplo (en C)</th></tr></thead><tbody>{CHORD_FORMULAS.map((formula, idx) => (<tr key={idx} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="px-3 sm:px-6 py-4 font-bold text-slate-900 dark:text-white">{formula.name}</td><td className="px-3 sm:px-6 py-4 font-mono text-brand-600 dark:text-brand-400 font-bold">{formula.formula}</td><td className="px-3 sm:px-6 py-4">{formula.example}</td></tr>))}</tbody></table></div>
                                    <p className="mt-4 text-xs text-slate-400 text-center">Los n煤meros representan los intervalos desde la t贸nica (1). b3 = Tercera menor, #5 = Quinta aumentada, etc.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const CircleOfFifths = () => {
            const [selectedKey, setSelectedKey] = useState('C');
            const WHEEL_ITEMS = [{ label: 'C', idx: 0 }, { label: 'G', idx: 1 }, { label: 'D', idx: 2 }, { label: 'A', idx: 3 }, { label: 'E', idx: 4 }, { label: 'B', idx: 5 }, { label: 'Gb', idx: 6 }, { label: 'Db', idx: 7 }, { label: 'Ab', idx: 8 }, { label: 'Eb', idx: 9 }, { label: 'Bb', idx: 10 }, { label: 'F', idx: 11 }];
            const getKeyDetails = (root) => {
                const details = { 'C':  { sub: 'F', subMin: 'Dm', dom: 'G', domMin: 'Em', min: 'Am', sharps: '0' }, 'G':  { sub: 'C', subMin: 'Am', dom: 'D', domMin: 'Bm', min: 'Em', sharps: '1 ' }, 'D':  { sub: 'G', subMin: 'Em', dom: 'A', domMin: 'F#m', min: 'Bm', sharps: '2 ' }, 'A':  { sub: 'D', subMin: 'Bm', dom: 'E', domMin: 'C#m', min: 'F#m', sharps: '3 ' }, 'E':  { sub: 'A', subMin: 'F#m', dom: 'B', domMin: 'G#m', min: 'C#m', sharps: '4 ' }, 'B':  { sub: 'E', subMin: 'C#m', dom: 'F#', domMin: 'D#m', min: 'G#m', sharps: '5 ' }, 'F#': { sub: 'B', subMin: 'G#m', dom: 'C#', domMin: 'A#m', min: 'D#m', sharps: '6 ' }, 'Gb': { sub: 'Cb', subMin: 'Abm', dom: 'Db', domMin: 'Bbm', min: 'Ebm', sharps: '6 ', flat: true }, 'Db': { sub: 'Gb', subMin: 'Ebm', dom: 'Ab', domMin: 'Fm', min: 'Bbm', sharps: '5 ', flat: true }, 'Ab': { sub: 'Db', subMin: 'Bbm', dom: 'Eb', domMin: 'Cm', min: 'Fm', sharps: '4 ', flat: true }, 'Eb': { sub: 'Ab', subMin: 'Fm', dom: 'Bb', domMin: 'Gm', min: 'Cm', sharps: '3 ', flat: true }, 'Bb': { sub: 'Eb', subMin: 'Cm', dom: 'F', domMin: 'Dm', min: 'Gm', sharps: '2 ', flat: true }, 'F':  { sub: 'Bb', subMin: 'Gm', dom: 'C', domMin: 'Am', min: 'Dm', sharps: '1 ', flat: true } };
                return details[root] || details['C'];
            };
            const current = getKeyDetails(selectedKey);
            const currentItem = WHEEL_ITEMS.find(item => item.label === selectedKey);
            const rotation = -30 * (currentItem ? currentItem.idx : (selectedKey === 'F#' ? 6 : 0));

            return (
                <div className="animate-fade-in flex flex-col items-center">
                    <div className="relative w-80 h-80 mb-8 mt-4">
                        <div className="w-full h-full rounded-full relative wheel-transition" style={{ transform: `rotate(${rotation}deg)` }}>
                            {WHEEL_ITEMS.map((k, i) => { const angle = 30 * i; const isSelected = k.label === selectedKey || (k.label === 'Gb' && selectedKey === 'F#'); const minKey = getKeyDetails(k.label).min; return (<div key={i} className="absolute w-full h-full left-0 top-0 pointer-events-none" style={{ transform: `rotate(${angle}deg)` }}><div onClick={(e) => { e.stopPropagation(); setSelectedKey(k.label); }} className={`pointer-events-auto cursor-pointer absolute left-1/2 -ml-[40px] top-0 w-[80px] h-[160px] flex flex-col items-center pt-2 transition-opacity ${isSelected ? 'opacity-100' : 'opacity-60 hover:opacity-80'}`}><span className={`text-lg font-bold ${isSelected ? 'text-brand-600 scale-125' : 'text-slate-800 dark:text-slate-200'} transition-transform bg-white/80 dark:bg-slate-900/80 px-2 rounded-lg`}>{k.label === 'Gb' ? 'Gb/F#' : k.label}</span><span className="text-xs font-medium text-slate-500 mt-1 bg-white/80 dark:bg-slate-900/80 px-1 rounded">{k.label === 'Gb' ? 'Ebm/D#m' : minKey}</span></div></div>); })}
                            <div className="absolute inset-0 m-auto w-40 h-40 rounded-full border-4 border-slate-200 dark:border-slate-700 pointer-events-none"></div>
                        </div>
                        <div className="absolute top-[-10px] left-1/2 -ml-3 w-6 h-6 text-brand-500 z-10"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21l-12-18h24z"/></svg></div>
                    </div>
                    <div className="w-full max-w-lg grid grid-cols-3 gap-3 text-center">
                        <div className="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700"><div className="text-[10px] font-bold text-slate-400 uppercase">Subdominante (IV)</div><div className="text-xl font-bold text-slate-700 dark:text-slate-200">{current.sub}</div><div className="text-xs text-slate-400">{current.subMin}</div></div>
                        <div className="bg-brand-50 dark:bg-brand-900/20 p-3 rounded-xl shadow-md border border-brand-200 dark:border-brand-800 scale-110 z-10 relative group"><div className="text-[10px] font-bold text-brand-500 uppercase">T贸nica (I)</div><div className="text-3xl font-black text-brand-600 dark:text-white">{selectedKey}</div><div className="text-sm font-bold text-slate-500 dark:text-slate-300">Relativa: {current.min}</div><div className="mt-1 text-xs bg-white dark:bg-slate-800 inline-block px-2 py-0.5 rounded-full text-slate-500">{current.sharps}</div>{(selectedKey === 'Gb' || selectedKey === 'F#') && (<div className="absolute -bottom-8 left-0 right-0 text-center"><button onClick={(e) => {e.stopPropagation(); setSelectedKey(prev => prev === 'Gb' ? 'F#' : 'Gb');}} className="text-[10px] text-brand-500 underline bg-white/50 dark:bg-slate-900/50 px-2 py-1 rounded">Ver como {selectedKey === 'Gb' ? 'F#' : 'Gb'}</button></div>)}</div>
                        <div className="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700"><div className="text-[10px] font-bold text-slate-400 uppercase">Dominante (V)</div><div className="text-xl font-bold text-slate-700 dark:text-slate-200">{current.dom}</div><div className="text-xs text-slate-400">{current.domMin}</div></div>
                    </div>
                    <p className="mt-8 text-slate-400 text-center text-xs max-w-xs">Usa el C铆rculo de Quintas para componer progresiones, modular a otras tonalidades o encontrar las notas alteradas de una escala.</p>
                </div>
            );
        };

        const TheoryHub = () => {
            const [activeTool, setActiveTool] = useState('circle'); 
            return (
                <div className="max-w-3xl mx-auto">
                    <div className="flex justify-center mb-8 bg-slate-200 dark:bg-slate-800 p-1 rounded-2xl w-fit mx-auto">
                        <button onClick={() => setActiveTool('circle')} className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${activeTool === 'circle' ? 'bg-white dark:bg-slate-700 text-brand-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>C铆rculo de Quintas</button>
                        <button onClick={() => setActiveTool('analyzer')} className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${activeTool === 'analyzer' ? 'bg-white dark:bg-slate-700 text-brand-600 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>Analizador</button>
                    </div>
                    {activeTool === 'analyzer' ? <ChordAnalyzer /> : <CircleOfFifths />}
                </div>
            );
        };

        const PracticeRoutine = () => {
            const [view, setView] = useState('landing');
            const [currentExercise, setCurrentExercise] = useState(null);
            const [timer, setTimer] = useState(0);
            const [isActive, setIsActive] = useState(false);
            const [customTime, setCustomTime] = useState(5);
            const intervalRef = useRef(null);

            const EXERCISES = [
                { id: 1, category: "CALENTAMIENTO", name: "Spider Walk (1-2-3-4)", desc: "Dedo por traste en todas las cuerdas. Ida y vuelta.", defaultTime: 5 },
                { id: 2, category: "TCNICA", name: "Bending y Vibrato", desc: "Bend de tono completo. Vibrato lento y controlado.", defaultTime: 10 },
                { id: 3, category: "RITMO", name: "Funk Strumming (Muting)", desc: "Mano izquierda muda cuerdas. Ritmo semicorcheas.", defaultTime: 10 },
                { id: 4, category: "TEORA", name: "Escala Mayor (3 Octavas)", desc: "C铆rculo de cuartas. Todas las posiciones.", defaultTime: 15 },
                { id: 5, category: "REPERTORIO", name: "Repaso Canciones", desc: "Tocar setlist completo sin detenerse.", defaultTime: 20 }
            ];

            useEffect(() => {
                if (isActive && timer > 0) {
                    intervalRef.current = setInterval(() => setTimer(t => t - 1), 1000);
                } else if (timer === 0) {
                    setIsActive(false);
                    if(intervalRef.current) clearInterval(intervalRef.current);
                }
                return () => clearInterval(intervalRef.current);
            }, [isActive, timer]);

            const startExercise = (ex) => {
                setCurrentExercise(ex);
                setCustomTime(ex.defaultTime);
                setTimer(ex.defaultTime * 60);
                setIsActive(false);
                setView('active');
            };

            const toggleTimer = () => setIsActive(!isActive);
            const resetTimer = () => { setIsActive(false); setTimer(customTime * 60); };
            const adjustTime = (delta) => {
                const newTime = Math.max(1, customTime + delta);
                setCustomTime(newTime);
                if (!isActive) setTimer(newTime * 60);
            };
            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            };

            if (view === 'landing') return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in">
                    <div className="w-24 h-24 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Icon name="zap" size={48} />
                    </div>
                    <h2 className="text-2xl font-bold mb-4 dark:text-white">Generador de Rutinas</h2>
                    <p className="text-slate-500 dark:text-slate-400 mb-8 leading-relaxed">Genera una sesi贸n equilibrada: Calentamiento + T茅cnica + Ritmo.</p>
                    <button onClick={() => setView('list')} className="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-indigo-600/30 hover:bg-indigo-700 hover:scale-105 transition-all w-full">Generar Nueva Rutina</button>
                </div>
            );

            if (view === 'list') return (
                <div className="max-w-xl mx-auto space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center px-2">
                        <h2 className="text-2xl font-bold dark:text-white">Tu Rutina de Hoy</h2>
                        <button onClick={() => setView('landing')} className="text-xs text-slate-400 font-bold hover:text-slate-600">Salir</button>
                    </div>
                    <div className="space-y-4">
                        {EXERCISES.map((ex) => (
                            <div key={ex.id} className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                                <div>
                                    <span className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mb-1 block">{ex.category}</span>
                                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-1">{ex.name}</h3>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 max-w-xs">{ex.desc}</p>
                                </div>
                                <button onClick={() => startExercise(ex)} className="bg-slate-900 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-indigo-600 transition-colors shrink-0">Practicar</button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 text-center animate-fade-in">
                    <button onClick={() => setView('list')} className="absolute top-6 left-6 p-2 bg-slate-100 dark:bg-slate-700 rounded-full text-slate-500 hover:text-slate-800"><Icon name="arrowLeft" size={20} /></button>
                    <span className="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-2 block mt-2">{currentExercise.category}</span>
                    <h2 className="text-2xl font-black mb-2 dark:text-white">{currentExercise.name}</h2>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mb-8">{currentExercise.desc}</p>
                    <div className="relative w-64 h-64 mx-auto mb-8 flex items-center justify-center">
                        <div className="absolute inset-0 rounded-full border-8 border-slate-100 dark:border-slate-700"></div>
                        <div className={`absolute inset-0 rounded-full border-8 border-indigo-500 transition-all duration-1000 ${isActive ? 'opacity-100' : 'opacity-30'}`} style={{ clipPath: `inset(0 0 ${100 - (timer / (customTime * 60) * 100)}% 0)` }}></div>
                        <div className="flex flex-col items-center z-10">
                            <span className="text-6xl font-black font-mono text-slate-800 dark:text-white tracking-tighter">{formatTime(timer)}</span>
                            {!isActive && <div className="flex gap-4 mt-2">
                                <button onClick={() => adjustTime(-1)} className="p-1 text-slate-400 hover:text-indigo-500"><Icon name="minus" size={16}/></button>
                                <span className="text-xs font-bold text-slate-500">{customTime} min</span>
                                <button onClick={() => adjustTime(1)} className="p-1 text-slate-400 hover:text-indigo-500"><Icon name="plus" size={16}/></button>
                            </div>}
                        </div>
                    </div>
                    <div className="flex gap-4 justify-center">
                        <button onClick={toggleTimer} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-95 ${isActive ? 'bg-amber-500 text-white' : 'bg-indigo-600 text-white'}`}><Icon name={isActive ? "pause" : "play"} size={32} fill="currentColor" /></button>
                        <button onClick={resetTimer} className="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-600"><Icon name="repeat" size={24} /></button>
                    </div>
                </div>
            );
        };

        const SongBook = () => {
            const [view, setView] = useState('list');
            const [songs, setSongs] = useState(() => {
                const saved = localStorage.getItem('gwt_songs');
                return saved ? JSON.parse(saved) : [];
            });
            const [currentSong, setCurrentSong] = useState(null);
            const dialog = useDialog();
            
            useEffect(() => { localStorage.setItem('gwt_songs', JSON.stringify(songs)); }, [songs]);

            const saveSong = (song) => {
                if (song.id) { setSongs(songs.map(s => s.id === song.id ? song : s)); } 
                else { setSongs([...songs, { ...song, id: Date.now() }]); }
                setView('list');
            };

            const deleteSong = (id, e) => {
                e.stopPropagation();
                dialog.confirm({
                    title: "驴Eliminar canci贸n?",
                    message: "Esta canci贸n se borrar谩 de tu repertorio permanentemente.",
                    onConfirm: () => setSongs(songs.filter(s => s.id !== id))
                });
            };

            const SongEditor = ({ song = {}, onSave, onCancel }) => {
                const [title, setTitle] = useState(song.title || '');
                const [artist, setArtist] = useState(song.artist || '');
                const [body, setBody] = useState(song.body || '');
                const [key, setKey] = useState(song.key || '');
                const [bpm, setBpm] = useState(song.bpm || '');

                return (
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl animate-fade-in">
                        <h3 className="text-xl font-bold mb-4 dark:text-white">{song.id ? 'Editar' : 'Nueva'} Canci贸n</h3>
                        <input className="w-full mb-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 dark:text-white font-bold" placeholder="T铆tulo" value={title} onChange={e => setTitle(e.target.value)} />
                        <input className="w-full mb-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 dark:text-white" placeholder="Artista" value={artist} onChange={e => setArtist(e.target.value)} />
                        <div className="flex flex-col sm:flex-row gap-3 mb-3">
                            <input className="flex-1 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 dark:text-white text-sm" placeholder="Tono (Ej: G)" value={key} onChange={e => setKey(e.target.value)} />
                            <input className="flex-1 p-3 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 dark:text-white text-sm" placeholder="BPM (Ej: 72)" type="number" value={bpm} onChange={e => setBpm(e.target.value)} />
                        </div>
                        <textarea className="w-full mb-4 p-4 h-64 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 font-mono text-sm dark:text-white" placeholder="Letra y Acordes..." value={body} onChange={e => setBody(e.target.value)}></textarea>
                        <div className="flex gap-3">
                            <button onClick={() => onSave({ ...song, title, artist, body, key, bpm })} className="flex-1 bg-cyan-600 text-white py-3 rounded-xl font-bold">Guardar</button>
                            <button onClick={onCancel} className="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-bold">Cancelar</button>
                        </div>
                    </div>
                );
            };

            if (view === 'editor') return <SongEditor song={currentSong} onSave={saveSong} onCancel={() => setView('list')} />;

            if (view === 'detail') return (
                <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-xl animate-fade-in">
                    <div className="flex justify-between items-start mb-6">
                        <button onClick={() => setView('list')} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full"><Icon name="rewind" size={20}/></button>
                        <div className="text-center">
                            <h2 className="text-2xl font-black dark:text-white">{currentSong.title}</h2>
                            <p className="text-cyan-600 font-bold">{currentSong.artist}</p>
                            {(currentSong.key || currentSong.bpm) && (
                                <div className="flex justify-center gap-3 mt-2">
                                    {currentSong.key && <span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500 font-bold">Key: {currentSong.key}</span>}
                                    {currentSong.bpm && <span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500 font-bold">BPM: {currentSong.bpm}</span>}
                                </div>
                            )}
                        </div>
                        <button onClick={() => setView('editor')} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full"><Icon name="edit" size={20}/></button>
                    </div>
                    <pre className="whitespace-pre-wrap font-mono text-sm dark:text-slate-300 bg-slate-50 dark:bg-slate-900 p-4 rounded-xl overflow-x-auto">{currentSong.body}</pre>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold dark:text-white flex items-center gap-2"><Icon name="book" className="text-cyan-500"/> Repertorio</h2>
                        <button onClick={() => { setCurrentSong({}); setView('editor'); }} className="bg-cyan-600 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2"><Icon name="plus" size={16}/> Nueva</button>
                    </div>
                    <div className="grid gap-3">
                        {songs.length === 0 && <p className="text-center text-slate-400 py-8 italic">No hay canciones guardadas.</p>}
                        {songs.map(song => (
                            <div key={song.id} onClick={() => { setCurrentSong(song); setView('detail'); }} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex justify-between items-center cursor-pointer hover:border-cyan-500 transition-colors group">
                                <div>
                                    <h3 className="font-bold dark:text-white">{song.title}</h3>
                                    <div className="flex gap-2 items-center">
                                        <p className="text-xs text-slate-500">{song.artist}</p>
                                        {(song.key || song.bpm) && <span className="text-[10px] text-slate-400"></span>}
                                        {song.key && <span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-1.5 rounded text-slate-500 font-bold">{song.key}</span>}
                                    </div>
                                </div>
                                <button onClick={(e) => deleteSong(song.id, e)} className="p-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash" size={18}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PadPlayer = ({ engine }) => {
            const { activeKey, setActiveKey, volume, setVolume, isPlaying, togglePlay, KEYS } = engine;
            return (
                <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-700 animate-fade-in">
                    <div className="flex items-center gap-4 mb-8"><div className="p-3 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-full"><Icon name="layers" size={32} /></div><div><h2 className="text-3xl font-black dark:text-white">Worship Pads</h2><p className="text-slate-500 text-sm">Sonido ambiental continuo</p></div></div>
                    <div className="grid grid-cols-4 gap-3 mb-8">{KEYS.map(k => (<button key={k} onClick={() => setActiveKey(k)} className={`py-4 rounded-xl font-bold text-lg transition-all shadow-sm ${activeKey === k && isPlaying ? 'bg-indigo-600 text-white shadow-indigo-500/50 scale-105' : 'bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}`}>{k}</button>))}</div>
                    <div className="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-2xl flex items-center gap-6"><button onClick={togglePlay} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-95 shrink-0 ${isPlaying ? 'bg-indigo-600 text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-400'}`}><Icon name={isPlaying ? "pause" : "play"} size={28} fill="currentColor" /></button><div className="flex-1"><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Volumen Master</label><input type="range" min="0" max="1" step="0.01" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer dark:bg-slate-700 accent-indigo-600"/></div></div>
                </div>
            );
        };

        const Footer = () => (<footer className="w-full text-center py-8 text-xs text-slate-400 font-medium">Copyright 漏 2026 LUFTMANDMAURICIO</footer>);

        const App = () => {
            const [view, setView] = useState('home');
            const [darkMode, setDarkMode] = useState(false);
            const [updateTrigger, setUpdateTrigger] = useState(0);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showInstall, setShowInstall] = useState(false);
            const padEngine = usePadEngine();

            useEffect(() => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) setDarkMode(true);
                const handleStorage = () => setUpdateTrigger(p => p + 1);
                const handleStatsUpdate = () => setUpdateTrigger(p => p + 1);
                window.addEventListener('storage', handleStorage);
                window.addEventListener('gwt-stats-updated', handleStatsUpdate);
                const handleInstallPrompt = (e) => { e.preventDefault(); setDeferredPrompt(e); setShowInstall(true); };
                window.addEventListener('beforeinstallprompt', handleInstallPrompt);
                return () => { window.removeEventListener('storage', handleStorage); window.removeEventListener('gwt-stats-updated', handleStatsUpdate); window.removeEventListener('beforeinstallprompt', handleInstallPrompt); };
            }, []);

            useEffect(() => { darkMode ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark'); }, [darkMode]);

            const installApp = async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') { setDeferredPrompt(null); setShowInstall(false); } };
            const NavItem = ({ id, icon, label, isAction = false, onClick = null }) => { 
                if (isAction) { 
                    return (<button onClick={onClick} className="flex-shrink-0 min-w-[4.5rem] flex flex-col items-center gap-1 p-2 rounded-xl transition-all text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/10"><div className="p-2 rounded-full"><Icon name={icon} size={24} /></div><span className="text-[10px] font-bold">{label}</span></button>); 
                } 
                return (<button onClick={() => setView(id)} className={`flex-shrink-0 min-w-[4.5rem] flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${view === id ? 'text-brand-600 dark:text-brand-400' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}><div className={`p-2 rounded-full transition-all ${view === id ? 'bg-brand-50 dark:bg-brand-900/20' : ''}`}><Icon name={icon} size={24} /></div><span className="text-[10px] font-bold">{label}</span></button>); 
            };

            return (
                <DialogProvider>
                    <div className="min-h-screen pb-24 md:pb-0 md:pl-24 flex flex-col">
                        <nav className="hidden md:flex fixed left-0 top-0 h-screen w-24 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex-col z-50">
                            <div className="flex justify-center w-full py-6 shrink-0"><div className="w-12 h-12 bg-brand-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-brand-600/30">GW</div></div>
                            <div className="flex-1 overflow-y-auto w-full px-2 flex flex-col items-center gap-3 no-scrollbar py-2"><NavItem id="home" icon="home" label="Inicio" /><NavItem id="tuner" icon="mic" label="Afinar" /><NavItem id="tracks" icon="music" label="Pistas" /><NavItem id="metronome" icon="activity" label="Tempo" /><NavItem id="pads" icon="layers" label="Pads" /><NavItem id="looper" icon="repeat" label="Looper" /><NavItem id="recorder" icon="mic" label="Ideas" /><NavItem id="routine" icon="zap" label="Rutinas" /><NavItem id="scales" icon="grid" label="Escalas" /><NavItem id="ear" icon="ear" label="O铆do" /><NavItem id="analyze" icon="analyze" label="Teor铆a" /><NavItem id="songs" icon="book" label="Songs" />{showInstall && <div className="w-full border-t border-slate-100 dark:border-slate-800 my-2"></div>}{showInstall && <NavItem id="install" icon="download" label="Instalar" isAction={true} onClick={installApp} />}</div>
                            <div className="flex justify-center w-full py-6 shrink-0"><button onClick={() => setDarkMode(!darkMode)} className="p-3 bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-brand-600 dark:text-slate-400 rounded-full transition-all hover:scale-110 shadow-sm border border-slate-200 dark:border-slate-700" title="Modo Oscuro/Claro"><Icon name={darkMode ? "sun" : "moon"} size={22} /></button></div>
                        </nav>
                        
                        <nav className="md:hidden fixed bottom-0 left-0 w-full bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-t border-slate-200 dark:border-slate-800 z-50 px-4 py-2 flex items-center gap-2 overflow-x-auto no-scrollbar safe-area-pb">
                            <NavItem id="home" icon="home" label="Inicio" />
                            <NavItem id="tuner" icon="mic" label="Afinar" />
                            <NavItem id="tracks" icon="music" label="Pistas" />
                            <NavItem id="metronome" icon="activity" label="Tempo" />
                            <NavItem id="pads" icon="layers" label="Pads" />
                            <NavItem id="looper" icon="repeat" label="Loop" />
                            <NavItem id="recorder" icon="mic" label="Ideas" />
                            <NavItem id="routine" icon="zap" label="Rutinas" />
                            <NavItem id="scales" icon="grid" label="Escalas" />
                            <NavItem id="ear" icon="ear" label="O铆do" />
                            <NavItem id="analyze" icon="analyze" label="Teor铆a" />
                            <NavItem id="songs" icon="book" label="Songs" />
                            {showInstall && <div className="h-8 w-[1px] bg-slate-200 dark:bg-slate-700 mx-2 shrink-0"></div>}
                            {showInstall && <NavItem id="install" icon="download" label="App" isAction={true} onClick={installApp} />}
                        </nav>

                        <main className="max-w-5xl mx-auto p-4 md:p-12 pb-32 animate-fade-in flex-grow w-full">
                            <div className="flex justify-end md:hidden mb-6"><button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm text-slate-500"><Icon name={darkMode ? "sun" : "moon"} size={20} /></button></div>
                            
                            {padEngine.isPlaying && view !== 'pads' && (
                                <div onClick={() => setView('pads')} className="fixed bottom-24 right-4 md:bottom-8 md:right-8 bg-indigo-600 text-white p-3 rounded-full shadow-2xl z-[60] cursor-pointer animate-pulse-ring flex items-center justify-center">
                                    <Icon name="layers" size={24} />
                                    <span className="absolute -top-1 -right-1 bg-red-500 text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">{padEngine.activeKey}</span>
                                </div>
                            )}

                            {view === 'home' && (
                                <div className="space-y-8 py-8">
                                    <div className="text-center space-y-4"><h1 className="text-4xl md:text-5xl font-extrabold text-slate-800 dark:text-white tracking-tight">Guitar <span className="text-brand-600">Worship</span> Trainer</h1><p className="text-slate-500 dark:text-slate-400 max-w-lg mx-auto text-lg">Tu compa帽ero de ensayo todo en uno.</p><div className="max-w-md mx-auto mt-6"><ProgressStats key={updateTrigger} /></div></div>
                                    <div><h3 className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-4 px-1">Herramientas</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><div onClick={() => setView('tuner')} className="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-xl shadow-indigo-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="mic" size={24} /></div><h3 className="font-bold text-lg">Afinador</h3><p className="text-xs opacity-90 mt-1">Crom谩tico</p></div><div onClick={() => setView('tracks')} className="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-xl shadow-indigo-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="music" size={24} /></div><h3 className="font-bold text-lg">Pistas</h3><p className="text-xs opacity-90 mt-1">Cargar MP3 & Loop</p></div><div onClick={() => setView('metronome')} className="bg-gradient-to-br from-rose-500 to-orange-500 p-6 rounded-2xl shadow-xl shadow-rose-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="activity" size={24} /></div><h3 className="font-bold text-lg">Metr贸nomo</h3><p className="text-xs opacity-90 mt-1">Speed Trainer</p></div><div onClick={() => setView('pads')} className="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-xl shadow-blue-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="layers" size={24} /></div><h3 className="font-bold text-lg">Worship Pads</h3><p className="text-xs opacity-90 mt-1">Ambiente continuo</p></div><div onClick={() => setView('looper')} className="bg-gradient-to-br from-teal-500 to-emerald-600 p-6 rounded-2xl shadow-xl shadow-teal-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="repeat" size={24} /></div><h3 className="font-bold text-lg">Jam Looper</h3><p className="text-xs opacity-90 mt-1">Graba & Toca encima</p></div><div onClick={() => setView('recorder')} className="bg-gradient-to-br from-red-500 to-pink-600 p-6 rounded-2xl shadow-xl shadow-red-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="mic" size={24} /></div><h3 className="font-bold text-lg">Grabadora</h3><p className="text-xs opacity-90 mt-1">Ideas & Riffs</p></div></div></div>
                                    <div><h3 className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-4 px-1">Entrenamiento</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><div onClick={() => setView('routine')} className="bg-gradient-to-br from-amber-500 to-yellow-600 p-6 rounded-2xl shadow-xl shadow-amber-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="zap" size={24} /></div><h3 className="font-bold text-lg">Rutinas</h3><p className="text-xs opacity-90 mt-1">El茅ctrica</p></div><div onClick={() => setView('scales')} className="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-xl shadow-emerald-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="grid" size={24} /></div><h3 className="font-bold text-lg">Escalas</h3><p className="text-xs opacity-90 mt-1">M谩stil & Tr铆adas</p></div><div onClick={() => setView('ear')} className="bg-gradient-to-br from-fuchsia-500 to-pink-600 p-6 rounded-2xl shadow-xl shadow-fuchsia-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="ear" size={24} /></div><h3 className="font-bold text-lg">O铆do</h3><p className="text-xs opacity-90 mt-1">Entrenador</p></div></div></div>
                                    <div><h3 className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-4 px-1">Conocimiento</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><div onClick={() => setView('analyze')} className="bg-gradient-to-br from-violet-500 to-fuchsia-600 p-6 rounded-2xl shadow-xl shadow-violet-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white"><div className="mb-3 opacity-80"><Icon name="analyze" size={24} /></div><h3 className="font-bold text-lg">Teor铆a</h3><p className="text-xs opacity-90 mt-1">Analizador</p></div><div onClick={() => setView('songs')} className="bg-gradient-to-br from-cyan-500 to-blue-600 p-6 rounded-2xl shadow-xl shadow-cyan-500/20 cursor-pointer hover:scale-[1.02] transition-transform text-white md:col-span-2"><div className="mb-3 opacity-80"><Icon name="book" size={24} /></div><h3 className="font-bold text-lg">Repertorio</h3><p className="text-xs opacity-90 mt-1">Gestiona tus canciones y letras.</p></div></div></div>
                                </div>
                            )}
                            {view === 'tuner' && <Tuner />}
                            {view === 'tracks' && <TrackTrainer />}
                            {view === 'metronome' && <Metronome />}
                            {view === 'routine' && <PracticeRoutine />}
                            {view === 'analyze' && <TheoryHub />}
                            {view === 'songs' && <SongBook />}
                            {view === 'scales' && <ScaleStudio />}
                            {view === 'ear' && <EarTrainer />}
                            {view === 'recorder' && <IdeaRecorder />}
                            {view === 'looper' && <JamLooper />}
                            {view === 'pads' && <PadPlayer engine={padEngine} />}
                        </main>
                        <Footer />
                    </div>
                </DialogProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>